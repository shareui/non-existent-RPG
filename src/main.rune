use game::world;
use game::player;
use game::combat;
use game::quests;
use std::io::{input, inputLine};
use std::time::{sleep};

entry main() {
    displayWelcome();
    
    string name = input("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ³ĞµÑ€Ğ¾Ñ: ");
    player::Player mut hero = player::Player(name);
    
    world::GameWorld mut gameWorld = world::GameWorld();
    quests::QuestManager mut questManager = quests::QuestManager();
    
    questManager.initializeQuests();
    gameWorld.initializeLocations();
    
    bool mut gameRunning = true;
    
    while gameRunning {
        displayMainMenu();
        string choice = inputLine();
        
        option choice {
            "1" -> {
                exploreWorld(&mut hero, &mut gameWorld, &mut questManager);
            },
            "2" -> {
                displayCharacterInfo(&hero);
            },
            "3" -> {
                manageInventory(&mut hero);
            },
            "4" -> {
                displayQuests(&questManager);
            },
            "5" -> {
                visitShop(&mut hero);
            },
            "6" -> {
                restAtInn(&mut hero);
            },
            "7" -> {
                outln("\nĞ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ¸Ğ³Ñ€Ñƒ! Ğ”Ğ¾ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸, " + hero.name + "!");
                gameRunning = false;
            },
            _ -> {
                outln("\nĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.");
            }
        }
        
        if gameRunning and not hero.isAlive() {
            outln("\n=== GAME OVER ===");
            outln("Ğ’Ğ°Ñˆ Ğ³ĞµÑ€Ğ¾Ğ¹ Ğ¿Ğ¾Ğ³Ğ¸Ğ± Ğ² Ğ±Ğ¾Ñ...");
            gameRunning = false;
        }
    }
}

local displayWelcome() -> void {
    outln("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    outln("â•‘   Ğ”ĞĞ‘Ğ Ğ ĞŸĞĞ–ĞĞ›ĞĞ’ĞĞ¢Ğ¬ Ğ’ RUNIC QUEST RPG   â•‘");
    outln("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    outln("");
}

local displayMainMenu() -> void {
    outln("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    outln("â•‘            Ğ“Ğ›ĞĞ’ĞĞĞ• ĞœĞ•ĞĞ®                â•‘");
    outln("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    outln("â•‘ 1. Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ñ€                     â•‘");
    outln("â•‘ 2. Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğµ              â•‘");
    outln("â•‘ 3. Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ                           â•‘");
    outln("â•‘ 4. ĞšĞ²ĞµÑÑ‚Ñ‹                              â•‘");
    outln("â•‘ 5. ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½                             â•‘");
    outln("â•‘ 6. ĞÑ‚Ğ´Ğ¾Ñ…Ğ½ÑƒÑ‚ÑŒ Ğ² Ñ‚Ğ°Ğ²ĞµÑ€Ğ½Ğµ                 â•‘");
    outln("â•‘ 7. Ğ’Ñ‹Ñ…Ğ¾Ğ´                               â•‘");
    outln("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    out("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: ");
}

local exploreWorld(hero: &mut player::Player, world: &mut world::GameWorld, questMgr: &mut quests::QuestManager) -> void {
    list<world::Location> locations = world.getAvailableLocations(hero.level);
    
    if len(locations) == 0 {
        outln("\nĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ.");
        return;
    }
    
    outln("\n=== Ğ”ĞĞ¡Ğ¢Ğ£ĞŸĞĞ«Ğ• Ğ›ĞĞšĞĞ¦Ğ˜Ğ˜ ===");
    for (index, loc) in locations {
        outln("#[index + 1]. #[loc.name] (Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ: #[loc.recommendedLevel])");
        outln("   #[loc.description]");
    }
    
    out("\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ (0 - Ğ½Ğ°Ğ·Ğ°Ğ´): ");
    string choice = inputLine();
    
    if choice == "0" {
        return;
    }
    
    num? locIndex = choice.toNum();
    if locIndex == void or locIndex < 1 or locIndex > len(locations) {
        outln("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€.");
        return;
    }
    
    world::Location selectedLoc = locations[locIndex - 1];
    exploreLocation(hero, selectedLoc, questMgr);
}

local exploreLocation(hero: &mut player::Player, location: world::Location, questMgr: &mut quests::QuestManager) -> void {
    outln("\n=== " + location.name + " ===");
    outln(location.description);
    sleep(1);
    
    num eventRoll = randomInt(1, 100);
    
    if eventRoll <= 60 {
        startCombat(hero, location, questMgr);
    } elif eventRoll <= 80 {
        findTreasure(hero, location);
    } else {
        outln("\nĞ’Ñ‹ Ğ¸ÑÑĞ»ĞµĞ´ÑƒĞµÑ‚Ğµ Ğ¼ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ, Ğ½Ğ¾ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ½Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚Ğµ.");
    }
}

local startCombat(hero: &mut player::Player, location: world::Location, questMgr: &mut quests::QuestManager) -> void {
    combat::Enemy mut enemy = combat::Enemy::generate(location.recommendedLevel);
    
    outln("\nâš”ï¸  ĞĞĞ§ĞĞ›Ğ¡Ğ¯ Ğ‘ĞĞ™!");
    outln("Ğ’Ñ‹ Ğ²ÑÑ‚Ñ€ĞµÑ‚Ğ¸Ğ»Ğ¸: " + enemy.name);
    sleep(1);
    
    bool mut combatActive = true;
    
    while combatActive and hero.isAlive() and enemy.isAlive() {
        displayCombatStatus(hero, &enemy);
        
        outln("\n1. ĞÑ‚Ğ°ĞºĞ¾Ğ²Ğ°Ñ‚ÑŒ");
        outln("2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·ĞµĞ»ÑŒĞµ");
        outln("3. ĞŸĞ¾Ğ¿Ñ‹Ñ‚Ğ°Ñ‚ÑŒÑÑ ÑĞ±ĞµĞ¶Ğ°Ñ‚ÑŒ");
        out("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: ");
        
        string action = inputLine();
        
        option action {
            "1" -> {
                playerAttack(hero, &mut enemy);
                if enemy.isAlive() {
                    enemyAttack(&mut enemy, hero);
                }
            },
            "2" -> {
                if usePotion(hero) {
                    enemyAttack(&mut enemy, hero);
                } else {
                    outln("Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ·ĞµĞ»Ğ¸Ğ¹!");
                }
            },
            "3" -> {
                if attemptFlee() {
                    outln("\nĞ’Ğ°Ğ¼ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ±ĞµĞ¶Ğ°Ñ‚ÑŒ!");
                    combatActive = false;
                } else {
                    outln("\nĞ¡Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ!");
                    enemyAttack(&mut enemy, hero);
                }
            },
            _ -> {
                outln("ĞĞµĞ²ĞµÑ€Ğ½Ğ¾Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ!");
            }
        }
        
        if not enemy.isAlive() {
            onVictory(hero, &enemy, questMgr);
            combatActive = false;
        }
    }
}

local displayCombatStatus(hero: &player::Player, enemy: &combat::Enemy) -> void {
    outln("\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    outln("â”‚ " + hero.name + " HP: #[hero.health]/#[hero.maxHealth] | MP: #[hero.mana]/#[hero.maxMana]");
    outln("â”‚ " + enemy.name + " HP: #[enemy.health]/#[enemy.maxHealth]");
    outln("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
}

local playerAttack(hero: &mut player::Player, enemy: &mut combat::Enemy) -> void {
    num damage = hero.calculateDamage();
    enemy.takeDamage(damage);
    outln("\nâš”ï¸  Ğ’Ñ‹ Ğ°Ñ‚Ğ°ĞºÑƒĞµÑ‚Ğµ " + enemy.name + " Ğ¸ Ğ½Ğ°Ğ½Ğ¾ÑĞ¸Ñ‚Ğµ #[damage] ÑƒÑ€Ğ¾Ğ½Ğ°!");
    sleep(1);
}

local enemyAttack(enemy: &mut combat::Enemy, hero: &mut player::Player) -> void {
    num damage = enemy.calculateDamage();
    hero.takeDamage(damage);
    outln("ğŸ’€ " + enemy.name + " Ğ°Ñ‚Ğ°ĞºÑƒĞµÑ‚ Ğ¸ Ğ½Ğ°Ğ½Ğ¾ÑĞ¸Ñ‚ Ğ²Ğ°Ğ¼ #[damage] ÑƒÑ€Ğ¾Ğ½Ğ°!");
    sleep(1);
}

local usePotion(hero: &mut player::Player) -> bool {
    list<player::Item> potions = hero.inventory.getItemsByType(player::ItemType::Potion);
    
    if len(potions) == 0 {
        return false;
    }
    
    player::Item potion = potions[0];
    hero.useItem(potion);
    return true;
}

local attemptFlee() -> bool {
    num roll = randomInt(1, 100);
    return roll > 50;
}

local onVictory(hero: &mut player::Player, enemy: &combat::Enemy, questMgr: &mut quests::QuestManager) -> void {
    outln("\nğŸ‰ ĞŸĞĞ‘Ğ•Ğ”Ğ!");
    
    num expGained = enemy.expReward;
    num goldGained = enemy.goldReward;
    
    hero.gainExperience(expGained);
    hero.gold += goldGained;
    
    outln("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾: #[expGained] Ğ¾Ğ¿Ñ‹Ñ‚Ğ°, #[goldGained] Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°");
    
    questMgr.updateKillQuests(enemy.type, 1);
    
    if randomInt(1, 100) > 60 {
        player::Item loot = generateLoot(enemy.level);
        hero.inventory.addItem(loot);
        outln("ĞĞ°Ğ¹Ğ´ĞµĞ½ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚: " + loot.name);
    }
    
    sleep(2);
}

local generateLoot(level: num) -> player::Item {
    num roll = randomInt(1, 100);
    
    if roll <= 40 {
        return player::Item("ĞœĞ°Ğ»Ğ¾Ğµ Ğ·ĞµĞ»ÑŒĞµ Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ", player::ItemType::Potion, level * 5 + 10, 50);
    } elif roll <= 70 {
        return player::Item("Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ¼ĞµÑ‡", player::ItemType::Weapon, level * 10 + 20, level * 3 + 5);
    } else {
        return player::Item("ĞšĞ¾Ğ¶Ğ°Ğ½Ğ°Ñ Ğ±Ñ€Ğ¾Ğ½Ñ", player::ItemType::Armor, level * 8 + 15, level * 2 + 3);
    }
}

local findTreasure(hero: &mut player::Player, location: world::Location) -> void {
    outln("\nğŸ’ Ğ’Ñ‹ Ğ½Ğ°ÑˆĞ»Ğ¸ ÑĞ¾ĞºÑ€Ğ¾Ğ²Ğ¸Ñ‰Ğµ!");
    
    num goldFound = randomInt(location.recommendedLevel * 10, location.recommendedLevel * 30);
    hero.gold += goldFound;
    
    outln("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾: #[goldFound] Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°");
    
    if randomInt(1, 100) > 70 {
        player::Item treasure = generateLoot(location.recommendedLevel);
        hero.inventory.addItem(treasure);
        outln("Ğ¢Ğ°ĞºĞ¶Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: " + treasure.name);
    }
    
    sleep(2);
}

local displayCharacterInfo(hero: &player::Player) -> void {
    outln("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    outln("â•‘      Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ¯ Ğ ĞŸĞ•Ğ Ğ¡ĞĞĞĞ–Ğ•            â•‘");
    outln("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    outln("â•‘ Ğ˜Ğ¼Ñ: " + hero.name);
    outln("â•‘ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ: #[hero.level]");
    outln("â•‘ ĞĞ¿Ñ‹Ñ‚: #[hero.experience]/#[hero.experienceToNextLevel]");
    outln("â•‘ HP: #[hero.health]/#[hero.maxHealth]");
    outln("â•‘ MP: #[hero.mana]/#[hero.maxMana]");
    outln("â•‘ Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾: #[hero.gold]");
    outln("â•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    outln("â•‘ ĞÑ‚Ğ°ĞºĞ°: #[hero.attack]");
    outln("â•‘ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ°: #[hero.defense]");
    outln("â•‘ ĞœĞ°Ğ³Ğ¸Ñ: #[hero.magic]");
    outln("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    out("\nĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Enter Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ...");
    inputLine();
}

local manageInventory(hero: &mut player::Player) -> void {
    bool mut inInventory = true;
    
    while inInventory {
        outln("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        outln("â•‘            Ğ˜ĞĞ’Ğ•ĞĞ¢ĞĞ Ğ¬                   â•‘");
        outln("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
        outln("â•‘ Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾: #[hero.gold]");
        outln("â•‘ ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚Ğ¾Ğ²: #[hero.inventory.getSize()]/#[hero.inventory.capacity]");
        outln("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        list<player::Item> items = hero.inventory.getAllItems();
        
        if len(items) == 0 {
            outln("\nĞ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ Ğ¿ÑƒÑÑ‚.");
            return;
        }
        
        outln("\nĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹:");
        for (index, item) in items {
            string typeStr = itemTypeToString(item.type);
            outln("#[index + 1]. #[item.name] (#[typeStr]) - Ğ¦ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ: #[item.value]");
        }
        
        outln("\n1. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚");
        outln("2. Ğ­ĞºĞ¸Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚");
        outln("3. ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚");
        outln("0. ĞĞ°Ğ·Ğ°Ğ´");
        
        out("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: ");
        string choice = inputLine();
        
        option choice {
            "1" -> useItemFromInventory(hero, items),
            "2" -> equipItem(hero, items),
            "3" -> sellItem(hero, items),
            "0" -> inInventory = false,
            _ -> outln("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€.")
        }
    }
}

local useItemFromInventory(hero: &mut player::Player, items: list<player::Item>) -> void {
    out("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°: ");
    string itemChoice = inputLine();
    
    num? itemIndex = itemChoice.toNum();
    if itemIndex == void or itemIndex < 1 or itemIndex > len(items) {
        outln("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°.");
        return;
    }
    
    player::Item selectedItem = items[itemIndex - 1];
    hero.useItem(selectedItem);
}

local equipItem(hero: &mut player::Player, items: list<player::Item>) -> void {
    out("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°: ");
    string itemChoice = inputLine();
    
    num? itemIndex = itemChoice.toNum();
    if itemIndex == void or itemIndex < 1 or itemIndex > len(items) {
        outln("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°.");
        return;
    }
    
    player::Item selectedItem = items[itemIndex - 1];
    hero.equipItem(selectedItem);
}

local sellItem(hero: &mut player::Player, items: list<player::Item>) -> void {
    out("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°: ");
    string itemChoice = inputLine();
    
    num? itemIndex = itemChoice.toNum();
    if itemIndex == void or itemIndex < 1 or itemIndex > len(items) {
        outln("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°.");
        return;
    }
    
    player::Item selectedItem = items[itemIndex - 1];
    num sellPrice = selectedItem.value / 2;
    
    hero.inventory.removeItem(selectedItem);
    hero.gold += sellPrice;
    
    outln("ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ½ Ğ·Ğ° #[sellPrice] Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°.");
}

local itemTypeToString(type: player::ItemType) -> string {
    return match type {
        player::ItemType::Weapon -> "ĞÑ€ÑƒĞ¶Ğ¸Ğµ",
        player::ItemType::Armor -> "Ğ‘Ñ€Ğ¾Ğ½Ñ",
        player::ItemType::Potion -> "Ğ—ĞµĞ»ÑŒĞµ",
        player::ItemType::Misc -> "Ğ Ğ°Ğ·Ğ½Ğ¾Ğµ"
    };
}

local displayQuests(questMgr: &quests::QuestManager) -> void {
    outln("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    outln("â•‘              ĞšĞ’Ğ•Ğ¡Ğ¢Ğ«                    â•‘");
    outln("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    list<quests::Quest> activeQuests = questMgr.getActiveQuests();
    
    if len(activeQuests) == 0 {
        outln("\nĞ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… ĞºĞ²ĞµÑÑ‚Ğ¾Ğ².");
    } else {
        outln("\nĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ĞºĞ²ĞµÑÑ‚Ñ‹:");
        for quest in activeQuests {
            string progressStr = quest.getProgressString();
            outln("â€¢ " + quest.name + " - " + progressStr);
            outln("  ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: #[quest.goldReward] Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°, #[quest.expReward] Ğ¾Ğ¿Ñ‹Ñ‚Ğ°");
        }
    }
    
    list<quests::Quest> completedQuests = questMgr.getCompletedQuests();
    if len(completedQuests) > 0 {
        outln("\nĞ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ ĞºĞ²ĞµÑÑ‚Ñ‹: #[len(completedQuests)]");
    }
    
    out("\nĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Enter Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ...");
    inputLine();
}

local visitShop(hero: &mut player::Player) -> void {
    outln("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    outln("â•‘            ĞœĞĞ“ĞĞ—Ğ˜Ğ                     â•‘");
    outln("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    outln("â•‘ Ğ’Ğ°ÑˆĞµ Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ¾: #[hero.gold]");
    outln("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    list<player::Item> shopItems = [
        player::Item("ĞœĞ°Ğ»Ğ¾Ğµ Ğ·ĞµĞ»ÑŒĞµ Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ", player::ItemType::Potion, 50, 50),
        player::Item("Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ·ĞµĞ»ÑŒĞµ Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ", player::ItemType::Potion, 100, 100),
        player::Item("Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¾Ğµ Ğ·ĞµĞ»ÑŒĞµ Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ", player::ItemType::Potion, 200, 150),
        player::Item("Ğ¡Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼ĞµÑ‡", player::ItemType::Weapon, 500, 15),
        player::Item("ĞšĞ¾Ğ»ÑŒÑ‡ÑƒĞ³Ğ°", player::ItemType::Armor, 400, 10)
    ];
    
    outln("\nĞ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹:");
    for (index, item) in shopItems {
        outln("#[index + 1]. #[item.name] - #[item.value] Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°");
    }
    
    out("\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€ (0 - Ğ²Ñ‹Ñ…Ğ¾Ğ´): ");
    string choice = inputLine();
    
    if choice == "0" {
        return;
    }
    
    num? itemIndex = choice.toNum();
    if itemIndex == void or itemIndex < 1 or itemIndex > len(shopItems) {
        outln("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€.");
        return;
    }
    
    player::Item selectedItem = shopItems[itemIndex - 1];
    
    if hero.gold >= selectedItem.value {
        hero.gold -= selectedItem.value;
        hero.inventory.addItem(selectedItem);
        outln("ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾: " + selectedItem.name);
    } else {
        outln("ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°!");
    }
}

local restAtInn(hero: &mut player::Player) -> void {
    num innCost = 50;
    
    outln("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    outln("â•‘            Ğ¢ĞĞ’Ğ•Ğ ĞĞ                     â•‘");
    outln("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    outln("â•‘ Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°: #[innCost] Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°");
    outln("â•‘ Ğ’Ğ°ÑˆĞµ Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ¾: #[hero.gold]");
    outln("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    if hero.gold >= innCost {
        out("\nĞÑ‚Ğ´Ğ¾Ñ…Ğ½ÑƒÑ‚ÑŒ? (y/n): ");
        string choice = inputLine();
        
        if choice == "y" {
            hero.gold -= innCost;
            hero.rest();
            outln("\nĞ’Ñ‹ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾ Ğ¾Ñ‚Ğ´Ğ¾Ñ…Ğ½ÑƒĞ»Ğ¸. Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ Ğ¸ Ğ¼Ğ°Ğ½Ğ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹!");
            sleep(2);
        }
    } else {
        outln("\nĞ£ Ğ²Ğ°Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°.");
    }
}

local randomInt(min: num, max: num) -> num {
    return min + (randomNumber() % (max - min + 1));
}

local randomNumber() -> num {
    return 42;
}